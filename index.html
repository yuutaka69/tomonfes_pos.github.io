<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚¤ãƒ™ãƒ³ãƒˆç”¨POSãƒ¬ã‚¸ (å®Œæˆç‰ˆ)</title>
    <style>
        :root {
            --product-item-size: 250px;
            --product-item-font-size: 18px;
        }
        body, html { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Meiryo, sans-serif; height: 100dvh; overflow: hidden; background-color: #f4f7f6; }
        .container { display: flex; height: 100%; }
        .left-pane { flex: 0 0 220px; background-color: #34495e; color: white; padding: 15px; display: flex; flex-direction: column; }
        .left-pane-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #4a627a; padding-bottom: 10px; }
        .menu-title { font-size: 1.3em; margin: 0; }
        #hamburger-btn { display: none; background: none; border: none; color: white; font-size: 28px; cursor: pointer; padding: 0; }
        .left-pane ul { list-style: none; padding: 0; margin-top: 20px; }
        .left-pane li { padding: 16px 12px; cursor: pointer; border-radius: 8px; transition: background-color 0.2s; font-size: 1.1em; }
        .left-pane li.active, .left-pane li:hover { background-color: #4a627a; }
        .center-pane { flex-grow: 1; padding: 25px; overflow-y: auto; }
        .right-pane { flex: 0 0 380px; background-color: #ffffff; border-left: 1px solid #ddd; display: flex; flex-direction: column; }
        
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(var(--product-item-size), 1fr)); gap: 20px; }
        .grid-separator { grid-column: 1 / -1; font-weight: bold; color: #2980b9; margin-top: 15px; padding-bottom: 5px; border-bottom: 1px solid #eee; font-size: 1.2em; }
        .product-item { display: flex; flex-direction: column; justify-content: space-between; border: 1px solid #ddd; border-radius: 8px; text-align: center; cursor: pointer; background-color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s; padding: 12px; }
        .product-item .name { font-weight: 600; font-size: var(--product-item-font-size); margin-bottom: 8px; }
        .product-item .price { font-size: calc(var(--product-item-font-size) * 0.95); }
        .product-item .price .discounted { font-weight: bold; font-size: calc(var(--product-item-font-size) * 1.1); color: #e74c3c; }
        .product-item .price s { color: #999; }

        .cart-header { padding: 18px; font-size: 1.3em; font-weight: bold; border-bottom: 1px solid #eee; }
        .cart-header.editing { background-color: #e67e22; color: white; }
        .cart-items { flex-grow: 1; padding: 10px; overflow-y: auto; }
        .cart-footer { padding: 25px; border-top: 1px solid #eee; background-color: #fdfdfd; }
        .total-section { display: flex; justify-content: space-between; align-items: center; font-weight: bold; margin-bottom: 20px; }
        .total-section .label { font-size: 1.6em; color: #333; }
        .total-section .amount { font-size: 3em; color: #2c3e50; }
        .action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .action-buttons button { padding: 18px; border: none; border-radius: 8px; font-size: 1.2em; color: white; cursor: pointer; }
        #register-btn { background-color: #27ae60; }
        #register-btn.update { background-color: #e67e22; }
        #clear-btn { background-color: #c0392b; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 14px; border: 1px solid #ddd; text-align: left; font-size: 16px; }
        th { background-color: #ecf0f1; }
        .action-btn { padding: 5px 10px; margin-right: 5px; cursor: pointer; border-width: 1px; border-style: solid; border-radius: 3px; color: white; transition: opacity 0.2s; }
        .action-btn:hover { opacity: 0.8; }
        .action-btn:disabled { background-color: #bdc3c7; border-color: #a1a7a9; cursor: not-allowed; }
        .btn-edit { background-color: #3498db; border-color: #2980b9; }
        .btn-delete { background-color: #e74c3c; border-color: #c0392b; }
        
        #products-table tbody tr { cursor: grab; }
        #products-table tbody tr.dragging { opacity: 0.5; background: #ecf0f1; }
        #products-table tbody tr.drag-over { border-top: 2px solid #3498db; }
        
        .form-section { background: #fff; padding: 25px; border-radius: 10px; margin-top: 25px; border: 1px solid #e0e0e0; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-grid input { font-size: 16px; padding: 12px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 6px; }

        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 5px; padding: 16px; position: fixed; z-index: 10; right: 30px; top: 30px; font-size: 17px; opacity: 0; transition: opacity 0.5s, visibility 0.5s; }
        #toast.show { visibility: visible; opacity: 1; }

        /* â˜…â˜…â˜…å¤‰æ›´ç‚¹: ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ç”¨ã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–æœ€çµ‚èª¿æ•´â˜…â˜…â˜… */
        @media (max-width: 800px) {
            body, html { overflow: visible; }
            .container { flex-direction: column; height: 100dvh; overflow: hidden; /* ä¸­èº«ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯å„è¦ç´ ã«ä»»ã›ã‚‹ */ }

            /* 1. ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼ã‚’ã‚¹ãƒªãƒ åŒ–ãƒ»ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ */
            .left-pane { flex-shrink: 0; flex-direction: column; height: auto; padding: 0; }
            .left-pane-header { padding: 8px 15px; border-bottom: 1px solid #4a627a; }
            .menu-title { font-size: 1.1em; }
            #hamburger-btn { display: block; }
            .left-pane ul { display: none; margin-top: 0; }
            .left-pane.menu-open ul { display: block; }
            .left-pane li { border-radius: 0; }

            .center-pane { flex-grow: 1; overflow-y: auto; padding: 15px; } /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã« */
            .right-pane { display: none; } /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯éè¡¨ç¤º */
            
            /* 2. ä¼šè¨ˆã‚¨ãƒªã‚¢ã‚’ä¸‹éƒ¨å›ºå®šè¡¨ç¤º */
            .container[data-view="è²©å£²æ“ä½œ"] {
                position: relative;
                padding-bottom: 250px; /* ä¸‹éƒ¨å›ºå®šã‚¨ãƒªã‚¢åˆ†ã®ä½™ç™½ã‚’ç¢ºä¿ */
                box-sizing: border-box;
            }
            .container[data-view="è²©å£²æ“ä½œ"] .right-pane {
                display: flex;
                position: fixed; /* ç”»é¢ä¸‹éƒ¨ã«å›ºå®š */
                bottom: 0;
                left: 0;
                right: 0;
                height: 250px; /* å›ºå®šã®é«˜ã•ã‚’æŒ‡å®š */
                max-height: 250px;
                width: 100%;
                z-index: 5;
                border-top: 2px solid #34495e;
            }
            .container[data-view="è²©å£²æ“ä½œ"] .cart-items {
                display: none; /* ã‚¹ãƒãƒ›ã§ã¯ã‚«ãƒ¼ãƒˆå†…ã®å•†å“ãƒªã‚¹ãƒˆã¯éè¡¨ç¤ºã«ã—ã€ãƒ•ãƒƒã‚¿ãƒ¼ã®ã¿ã«ã™ã‚‹ */
            }
            
            /* 3. ãƒœã‚¿ãƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’ãƒªãƒƒãƒã«æˆ»ã™ */
            .cart-footer { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
            .total-section .label { font-size: 1.2em; }
            .total-section .amount { font-size: 2em; }
            .action-buttons button { padding: 15px; font-size: 1.1em; }

            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container" data-view="è²©å£²æ“ä½œ">
        <nav class="left-pane" id="left-pane">
            <div class="left-pane-header">
                <h2 class="menu-title">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
                <button id="hamburger-btn">â˜°</button>
            </div>
            <ul id="main-menu">
                <li>è²©å£²æ“ä½œ</li><li>é›†è¨ˆ</li><li>ãƒ¬ã‚·ãƒ¼ãƒˆå±¥æ­´</li><li>å•†å“ä¸€è¦§è¨­å®š</li><li>è¨­å®š</li>
            </ul>
        </nav>
        <main class="center-pane" id="center-pane"></main>
        <aside class="right-pane" id="right-pane"></aside>
    </div>
    <div id="toast"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- State and Data Management (No changes) ---
        let state = {
            products: [], cart: [], receipts: [], activeView: 'è²©å£²æ“ä½œ',
            editMode: { active: false, receiptDate: null },
            settings: { productItemSize: 250, productItemFontSize: 18 }
        };
        function saveData() { localStorage.setItem('posData', JSON.stringify({ products: state.products, receipts: state.receipts, settings: state.settings })); }
        function loadData() {
            const data = JSON.parse(localStorage.getItem('posData'));
            const defaultSettings = { productItemSize: 250, productItemFontSize: 18 };
            if (data) {
                state.products = data.products || getDefaultProducts();
                state.receipts = data.receipts || [];
                state.settings = data.settings || defaultSettings;
                if (!state.settings.productItemFontSize) { state.settings.productItemFontSize = defaultSettings.productItemFontSize; }
            } else { state.products = getDefaultProducts(); }
            applySettings();
        }
        function applySettings() {
            document.documentElement.style.setProperty('--product-item-size', `${state.settings.productItemSize}px`);
            document.documentElement.style.setProperty('--product-item-font-size', `${state.settings.productItemFontSize}px`);
        }
        function getDefaultProducts() { return [{ id: 1, name: "Tã‚·ãƒ£ãƒ„", price: 2500, cost: 1000, discountAmount: 0 },{ id: 2, name: "ãƒˆãƒ¼ãƒˆãƒãƒƒã‚°", price: 1800, cost: 700, discountAmount: 300 },{ id: 3, name: "ã‚¹ãƒ†ãƒƒã‚«ãƒ¼", price: 800, cost: 200, discountAmount: 0 }]; }

        // --- DOM Elements (No changes) ---
        const container = document.querySelector('.container');
        const leftPane = document.getElementById('left-pane');
        const centerPane = document.getElementById('center-pane');
        const rightPane = document.getElementById('right-pane');
        const menuItems = document.querySelectorAll('#main-menu li');
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const toast = document.getElementById('toast');
        function showToast(message) { toast.textContent = message; toast.classList.add('show'); setTimeout(() => { toast.classList.remove('show'); }, 3000); }

        hamburgerBtn.addEventListener('click', () => { leftPane.classList.toggle('menu-open'); });

        // --- Render Functions (No JS logic changes, only HTML strings in some) ---
        function render() {
            const view = state.activeView;
            container.dataset.view = view;
            rightPane.style.display = 'none';
            // First item in menu is active by default
            const activeMenuItem = Array.from(menuItems).find(item => item.textContent === view);
            menuItems.forEach(item => item.classList.remove('active'));
            if(activeMenuItem) activeMenuItem.classList.add('active');

            try {
                switch (view) {
                    case 'è²©å£²æ“ä½œ': renderSalesView(); rightPane.style.display = 'flex'; break;
                    case 'é›†è¨ˆ': renderSummaryView(); break;
                    case 'ãƒ¬ã‚·ãƒ¼ãƒˆå±¥æ­´': renderReceiptsView(); break;
                    case 'å•†å“ä¸€è¦§è¨­å®š': renderProductsSettingsView(); break;
                    case 'è¨­å®š': renderSettingsView(); break;
                }
            } catch (error) { console.error("æç”»ã‚¨ãƒ©ãƒ¼:", error); centerPane.innerHTML = "<h2>ã‚¨ãƒ©ãƒ¼</h2><p>æç”»ä¸­ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>"; }
        }
        
        function renderSalesView() {
            const isEditing = state.editMode.active; const headerClass = isEditing ? 'cart-header editing' : 'cart-header';
            const headerText = isEditing ? `ãƒ¬ã‚·ãƒ¼ãƒˆç·¨é›†ä¸­` : 'ç¾åœ¨ã®ä¼šè¨ˆ';
            const registerBtnClass = isEditing ? 'update' : ''; const registerBtnText = isEditing ? 'æ›´æ–°' : 'ç™»éŒ²';
            const clearBtnText = isEditing ? 'ç·¨é›†ä¸­æ­¢' : 'ã‚¯ãƒªã‚¢';
            
            centerPane.innerHTML = '<div class="product-grid"></div>';
            // â˜…å¤‰æ›´ç‚¹: ã‚¹ãƒãƒ›ã§ã¯ã‚«ãƒ¼ãƒˆå†…å•†å“ãƒªã‚¹ãƒˆã¯éè¡¨ç¤ºï¼ˆCSSã§åˆ¶å¾¡ï¼‰ã ãŒã€åˆè¨ˆã¯è¨ˆç®—ã™ã‚‹ãŸã‚JSã¯ãã®ã¾ã¾
            rightPane.innerHTML = `<div class="${headerClass}">${headerText}</div><div class="cart-items"></div><div class="cart-footer"><div class="total-section"><span class="label">åˆè¨ˆ</span><span class="amount" id="total-amount">Â¥0</span></div><div class="action-buttons"><button id="register-btn" class="${registerBtnClass}">${registerBtnText}</button><button id="clear-btn">${clearBtnText}</button></div></div>`;
            
            renderProductsGrid();
            renderCart();
            document.getElementById('clear-btn').addEventListener('click', isEditing ? cancelEditReceipt : clearCart);
            document.getElementById('register-btn').addEventListener('click', registerSaleOrUpdateReceipt);
        }
        
        function renderProductsGrid() {
            const productGrid = centerPane.querySelector('.product-grid'); if (!productGrid) return;
            productGrid.innerHTML = '';
            const normalProducts = state.products.filter(p => p.discountAmount === 0);
            const discountedProducts = state.products.filter(p => p.discountAmount > 0);
            const createItemHtml = p => {
                let priceHtml = p.discountAmount > 0 ? `<div class="price"><s>Â¥${p.price.toLocaleString()}</s> <span class="discounted">Â¥${(p.price - p.discountAmount).toLocaleString()}</span></div>` : `<div class="price">Â¥${p.price.toLocaleString()}</div>`;
                const item = document.createElement('div'); item.className = 'product-item';
                item.innerHTML = `<div class="name">${p.name}</div>${priceHtml}`;
                item.addEventListener('click', () => addProductToCart(p.id));
                productGrid.appendChild(item);
            };
            normalProducts.forEach(createItemHtml);
            if (discountedProducts.length > 0) {
                const separator = document.createElement('div'); separator.className = 'grid-separator';
                separator.textContent = 'å‰²å¼•å•†å“';
                productGrid.appendChild(separator);
                discountedProducts.forEach(createItemHtml);
            }
        }
        
        function renderCart() {
            const cartItemsContainer = rightPane.querySelector('.cart-items'); if (!cartItemsContainer) return;
            cartItemsContainer.innerHTML = ''; let total = 0;
            const normalItems = state.cart.filter(item => findProductById(item.id) && findProductById(item.id).discountAmount === 0);
            const discountedItems = state.cart.filter(item => findProductById(item.id) && findProductById(item.id).discountAmount > 0);
            const createItemHtml = (cartItem) => {
                const product = findProductById(item.id); if(!product) return { html: '', subtotal: 0 };
                const finalPrice = product.price - product.discountAmount;
                const subtotal = finalPrice * cartItem.quantity;
                const priceHtml = product.discountAmount > 0 ? `<span class="original-price">Â¥${product.price.toLocaleString()}</span> Â¥${finalPrice.toLocaleString()}` : `Â¥${product.price.toLocaleString()}`;
                const html = `<div class="cart-item"><div class="cart-item-info"><div class="name">${product.name}</div><div class="price">${cartItem.quantity} x ${priceHtml}</div></div><div class="cart-item-controls"><button class="decrease-btn" data-id="${cartItem.id}">-</button><span class="quantity">${cartItem.quantity}</span><button class="increase-btn" data-id="${cartItem.id}">+</button></div></div>`;
                return { html, subtotal };
            };
            normalItems.forEach(item => { const result = createItemHtml(item); cartItemsContainer.innerHTML += result.html; total += result.subtotal; });
            if(discountedItems.length > 0) {
                cartItemsContainer.innerHTML += '<div class="cart-separator">å‰²å¼•å•†å“</div>';
                discountedItems.forEach(item => { const result = createItemHtml(item); cartItemsContainer.innerHTML += result.html; total += result.subtotal; });
            }
            rightPane.querySelector('#total-amount').textContent = `Â¥${Math.floor(total).toLocaleString()}`;
            addCartButtonEvents();
        }

        function renderSummaryView() { let totalRevenue = 0, totalCost = 0; const salesSummary = {}; state.receipts.forEach(receipt => { receipt.items.forEach(item => { const product = findProductById(item.id); if (!product) return; if (!salesSummary[item.id]) salesSummary[item.id] = { name: product.name, quantity: 0, revenue: 0 }; const revenue = (product.price - product.discountAmount) * item.quantity; salesSummary[item.id].quantity += item.quantity; salesSummary[item.id].revenue += revenue; totalRevenue += revenue; totalCost += product.cost * item.quantity; }); }); const tableRows = Object.values(salesSummary).map(s => `<tr><td>${s.name}</td><td>${s.quantity}</td><td>Â¥${Math.floor(s.revenue).toLocaleString()}</td></tr>`).join(''); centerPane.innerHTML = `<h1>é›†è¨ˆ</h1><div class="summary-cards-container"><div class="summary-card"><h3>ç·å£²ä¸Š</h3><p>Â¥${Math.floor(totalRevenue).toLocaleString()}</p></div><div class="summary-card"><h3>ç·åŸä¾¡</h3><p>Â¥${Math.floor(totalCost).toLocaleString()}</p></div><div class="summary-card"><h3>ç·åˆ©ç›Š</h3><p class="profit">Â¥${Math.floor(totalRevenue - totalCost).toLocaleString()}</p></div></div><h2>å•†å“åˆ¥ å£²ä¸Šä¸€è¦§</h2><table><thead><tr><th>å•†å“å</th><th>è²©å£²æ•°</th><th>å£²ä¸Š</th></tr></thead><tbody>${tableRows}</tbody></table>`;}
        function renderReceiptsView() { const receiptListHtml = state.receipts.map((receipt) => { const itemsHtml = receipt.items.map(item => { const p = findProductById(item.id); return `<li>${p ? p.name : 'å‰Šé™¤æ¸ˆå•†å“'} x ${item.quantity}</li>`; }).join(''); return `<div class="receipt-card"><div class="receipt-card-header"><h4>ãƒ¬ã‚·ãƒ¼ãƒˆ #${receipt.id}</h4><span>${new Date(receipt.date).toLocaleString()}</span></div><p class="total">Â¥${receipt.total.toLocaleString()}</p><ul>${itemsHtml}</ul><div class="receipt-card-footer"><button class="action-btn btn-edit" onclick="editReceipt('${receipt.date}')">ç·¨é›†</button><button class="action-btn btn-delete" onclick="deleteReceipt('${receipt.date}')">å‰Šé™¤</button></div></div>`; }).join(''); centerPane.innerHTML = `<h1>ãƒ¬ã‚·ãƒ¼ãƒˆå±¥æ­´</h1><div class="receipt-grid">${receiptListHtml || '<p>ã¾ã ä¼šè¨ˆå±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>'}</div>`; }
        function renderProductsSettingsView() {
            let productsHtml = ''; state.products.forEach(p => { const isSold = isProductSold(p.id); productsHtml += `<tr draggable="${!isSold}" data-id="${p.id}"><td>${p.name} ${isSold ? 'ğŸ”’' : ''}</td><td>Â¥${p.price.toLocaleString()}</td><td>Â¥${p.cost.toLocaleString()}</td><td>Â¥${p.discountAmount.toLocaleString()}</td><td><button class="action-btn btn-edit" onclick="editProduct(${p.id})" ${isSold ? 'disabled' : ''}>ç·¨é›†</button><button class="action-btn btn-delete" onclick="deleteProduct(${p.id})" ${isSold ? 'disabled' : ''}>å‰Šé™¤</button></td></tr>`; });
            centerPane.innerHTML = `<h1>å•†å“ä¸€è¦§è¨­å®š</h1><p>è²©å£²å±¥æ­´ã®ãªã„å•†å“ã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§ä¸¦ã³æ›¿ãˆã§ãã¾ã™ã€‚</p><table id="products-table"><thead><tr><th>åå‰</th><th>ä¾¡æ ¼</th><th>åŸä¾¡</th><th>å‰²å¼•é¡</th><th>æ“ä½œ</th></tr></thead><tbody>${productsHtml}</tbody></table><div class="form-section"><h3 id="product-form-title">æ–°è¦å•†å“è¿½åŠ </h3><form id="product-form"><input type="hidden" id="product-id"><div class="form-grid"><input type="text" id="product-name" placeholder="å•†å“å" required><input type="number" id="product-price" placeholder="ä¾¡æ ¼" required><input type="number" id="product-cost" placeholder="åŸä¾¡" required><input type="number" id="product-discount-amount" placeholder="å‰²å¼•é¡ (ãªã‘ã‚Œã°0)" required></div><button type="submit" style="width:100%; padding:15px; margin-top:15px; background:#2980b9; color:white; border:none; border-radius:8px; font-size:1.1em;">ä¿å­˜</button></form></div>`;
            document.getElementById('product-form').addEventListener('submit', handleProductFormSubmit);
            const tableBody = document.querySelector('#products-table tbody'); let draggedItemId = null;
            tableBody.addEventListener('dragstart', e => { draggedItemId = e.target.dataset.id; e.target.classList.add('dragging'); });
            tableBody.addEventListener('dragend', e => e.target.classList.remove('dragging'));
            tableBody.addEventListener('dragover', e => { e.preventDefault(); const targetRow = e.target.closest('tr'); if (targetRow && targetRow.dataset.id !== draggedItemId && !isProductSold(targetRow.dataset.id)) { document.querySelectorAll('#products-table tr').forEach(row => row.classList.remove('drag-over')); targetRow.classList.add('drag-over'); } });
            tableBody.addEventListener('dragleave', e => e.target.closest('tr')?.classList.remove('drag-over'));
            tableBody.addEventListener('drop', e => { e.preventDefault(); document.querySelectorAll('#products-table tr').forEach(row => row.classList.remove('drag-over')); const targetRow = e.target.closest('tr'); if (targetRow && !isProductSold(targetRow.dataset.id)) { const droppedOnItemId = targetRow.dataset.id; const draggedIndex = state.products.findIndex(p => p.id == draggedItemId); const droppedOnIndex = state.products.findIndex(p => p.id == droppedOnItemId); const [draggedItem] = state.products.splice(draggedIndex, 1); state.products.splice(droppedOnIndex, 0, draggedItem); saveData(); render(); } });
        }
        function renderSettingsView() {
            centerPane.innerHTML = `<h1>è¨­å®š</h1><div class="setting-item"><label for="item-size-slider">è²©å£²ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚º: <span id="item-size-value">${state.settings.productItemSize}px</span></label><input type="range" id="item-size-slider" min="150" max="300" value="${state.settings.productItemSize}"></div><div class="setting-item"><label for="font-size-slider">ã‚¢ã‚¤ãƒ†ãƒ ã®æ–‡å­—ã‚µã‚¤ã‚º: <span id="font-size-value">${state.settings.productItemFontSize}px</span></label><input type="range" id="font-size-slider" min="12" max="28" value="${state.settings.productItemFontSize}"></div>`;
            const sizeSlider = document.getElementById('item-size-slider'); const sizeValueLabel = document.getElementById('item-size-value');
            sizeSlider.addEventListener('input', (e) => { state.settings.productItemSize = e.target.value; sizeValueLabel.textContent = `${e.target.value}px`; applySettings(); });
            sizeSlider.addEventListener('change', () => { saveData(); showToast('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ'); });
            const fontSlider = document.getElementById('font-size-slider'); const fontValueLabel = document.getElementById('font-size-value');
            fontSlider.addEventListener('input', (e) => { state.settings.productItemFontSize = e.target.value; fontValueLabel.textContent = `${e.target.value}px`; applySettings(); });
            fontSlider.addEventListener('change', () => { saveData(); showToast('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ'); });
        }
        
        function handleMenuClick(event) { if (state.editMode.active && !confirm("ãƒ¬ã‚·ãƒ¼ãƒˆã®ç·¨é›†ä¸­ã§ã™ã€‚å¤‰æ›´ã‚’ç ´æ£„ã—ã¦ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ")) return; cancelEditReceipt(); state.activeView = event.currentTarget.textContent; render(); leftPane.classList.remove('menu-open'); }
        function handleProductFormSubmit(e) { e.preventDefault(); const id = document.getElementById('product-id').value; const newProduct = { id: id ? parseInt(id) : Date.now(), name: document.getElementById('product-name').value, price: parseInt(document.getElementById('product-price').value) || 0, cost: parseInt(document.getElementById('product-cost').value) || 0, discountAmount: parseInt(document.getElementById('product-discount-amount').value) || 0 }; if (id) { state.products = state.products.map(p => p.id === newProduct.id ? newProduct : p); } else { state.products.push(newProduct); } saveData(); showToast('å•†å“ã‚’ä¿å­˜ã—ã¾ã—ãŸ'); render(); }
        window.editProduct = (id) => { if (isProductSold(id)) { showToast('è²©å£²å±¥æ­´ã®ã‚ã‚‹å•†å“ã¯ç·¨é›†ã§ãã¾ã›ã‚“ã€‚'); return; } const p = findProductById(id); if (!p) return; document.getElementById('product-form-title').textContent = 'å•†å“ã‚’ç·¨é›†'; document.getElementById('product-id').value = p.id; document.getElementById('product-name').value = p.name; document.getElementById('product-price').value = p.price; document.getElementById('product-cost').value = p.cost; document.getElementById('product-discount-amount').value = p.discountAmount; window.scrollTo(0, document.body.scrollHeight); }
        window.deleteProduct = (id) => { if (isProductSold(id)) { showToast('è²©å£²å±¥æ­´ã®ã‚ã‚‹å•†å“ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚'); return; } if (confirm('æœ¬å½“ã«ã“ã®å•†å“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { state.products = state.products.filter(p => p.id != id); saveData(); showToast('å•†å“ã‚’å‰Šé™¤ã—ã¾ã—ãŸ'); render(); } }
        window.deleteReceipt = (date) => { if (confirm('æœ¬å½“ã«ã“ã®ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { state.receipts = state.receipts.filter(r => r.date !== date); saveData(); showToast('ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ'); render(); } }
        window.editReceipt = (date) => { const receipt = state.receipts.find(r => r.date === date); if (!receipt) return; state.editMode = { active: true, receiptDate: date }; state.cart = JSON.parse(JSON.stringify(receipt.items)); state.activeView = 'è²©å£²æ“ä½œ'; render(); }
        function cancelEditReceipt() { state.editMode = { active: false, receiptDate: null }; state.cart = []; }
        function addProductToCart(productId) { const item = state.cart.find(item => item.id == productId); if (item) { item.quantity++; } else { state.cart.push({ id: productId, quantity: 1 }); } renderCart(); }
        function updateCartQuantity(productId, change) { const item = state.cart.find(item => item.id == parseInt(productId)); if (item) { item.quantity += change; if (item.quantity <= 0) state.cart = state.cart.filter(cartItem => cartItem.id != item.id); } renderCart(); }
        function addCartButtonEvents() { rightPane.querySelectorAll('.increase-btn').forEach(btn => btn.addEventListener('click', (e) => updateCartQuantity(e.target.dataset.id, 1))); rightPane.querySelectorAll('.decrease-btn').forEach(btn => btn.addEventListener('click', (e) => updateCartQuantity(e.target.dataset.id, -1))); }
        function clearCart() { state.cart = []; renderCart(); }
        function registerSaleOrUpdateReceipt() {
            if (state.editMode.active) {
                const receipt = state.receipts.find(r => r.date === state.editMode.receiptDate); if (!receipt) { showToast("ã‚¨ãƒ©ãƒ¼: å¯¾è±¡ã®ãƒ¬ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }
                const total = state.cart.reduce((sum, item) => { const p = findProductById(item.id); return sum + (p ? (p.price - p.discountAmount) * item.quantity : 0); }, 0);
                receipt.items = [...state.cart]; receipt.total = Math.floor(total); saveData(); showToast(`ãƒ¬ã‚·ãƒ¼ãƒˆ #${receipt.id} ã‚’æ›´æ–°ã—ã¾ã—ãŸ`);
                cancelEditReceipt(); state.activeView = 'ãƒ¬ã‚·ãƒ¼ãƒˆå±¥æ­´'; render();
            } else {
                if (state.cart.length === 0) { showToast('ã‚«ãƒ¼ãƒˆã«å•†å“ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
                const total = state.cart.reduce((sum, item) => { const p = findProductById(item.id); return sum + (p ? (p.price - p.discountAmount) * item.quantity : 0); }, 0);
                const receiptId = state.receipts.length > 0 ? Math.max(0, ...state.receipts.map(r => r.id)) + 1 : 1;
                state.receipts.unshift({ id: receiptId, date: new Date().toISOString(), items: [...state.cart], total: Math.floor(total) });
                saveData(); showToast(`Â¥${Math.floor(total).toLocaleString()} ã§å£²ä¸Šã‚’è¨˜éŒ²`); clearCart();
            }
        }
        function findProductById(id) { return state.products.find(p => p.id == id); }
        function isProductSold(productId) { return state.receipts.some(receipt => receipt.items.some(item => item.id == productId)); }
        function init() { loadData(); menuItems.forEach(item => item.addEventListener('click', handleMenuClick)); render(); }
        init();
    });
    </script>
</body>
</html>
