<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>イベント用POSレジ (v3)</title>
    <style>
        /* 基本スタイル */
        body, html { margin: 0; padding: 0; font-family: 'Segoe UI', Meiryo, sans-serif; height: 100vh; overflow: hidden; background-color: #f4f7f6; }
        .container { display: flex; height: 100%; }
        .left-pane { flex: 0 0 200px; background-color: #34495e; color: white; padding: 15px; }
        .left-pane .menu-title { font-size: 1.2em; margin-bottom: 20px; border-bottom: 1px solid #4a627a; padding-bottom: 10px; }
        .left-pane ul { list-style: none; padding: 0; }
        .left-pane li { padding: 15px 10px; cursor: pointer; border-radius: 5px; transition: background-color 0.2s; }
        .left-pane li.active, .left-pane li:hover { background-color: #4a627a; }
        .center-pane { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .right-pane { flex: 0 0 350px; background-color: #ffffff; border-left: 1px solid #ddd; display: flex; flex-direction: column; }
        
        /* 販売画面 */
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .product-item { border: 1px solid #ddd; border-radius: 8px; padding: 10px; text-align: center; cursor: pointer; background-color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s; }
        .product-item:hover { transform: translateY(-5px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .product-item .name { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; }
        .product-item .price { color: #555; font-size: 1em; }
        .product-item .price .discounted { font-weight: bold; font-size: 1.2em; color: #e74c3c; } /* ★変更点 */
        .product-item .price s { color: #999; font-size: 0.9em; } /* ★変更点 */

        /* カート画面 */
        .cart-header { padding: 15px; font-size: 1.2em; font-weight: bold; border-bottom: 1px solid #eee; }
        .cart-header.editing { background-color: #e67e22; color: white; } /* ★追加 */
        .cart-items { flex-grow: 1; padding: 10px; overflow-y: auto; }
        .cart-item { display: flex; align-items: center; margin-bottom: 10px; padding: 10px; border-radius: 5px; background-color: #f9f9f9; }
        .cart-item-info { flex-grow: 1; }
        .cart-item .name { font-weight: bold; }
        .cart-item .price { color: #555; font-size: 0.9em; }
        .cart-item .original-price { text-decoration: line-through; color: #999; margin-right: 5px; }
        .cart-item-controls { display: flex; align-items: center; }
        .cart-item-controls button { width: 30px; height: 30px; border: 1px solid #ccc; background: white; cursor: pointer; font-size: 1.2em; }
        .cart-item-controls .quantity { padding: 0 15px; font-size: 1.1em; }
        .cart-footer { padding: 20px; border-top: 1px solid #eee; background-color: #fdfdfd; }
        .total-section { display: flex; justify-content: space-between; font-size: 1.5em; font-weight: bold; margin-bottom: 20px; }
        .action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .action-buttons button { padding: 15px; border: none; border-radius: 5px; font-size: 1.1em; color: white; cursor: pointer; }
        #register-btn { background-color: #27ae60; }
        #register-btn.update { background-color: #e67e22; } /* ★追加 */
        #clear-btn { background-color: #c0392b; }
        .cart-separator { font-weight: bold; color: #2980b9; margin-top: 15px; padding-bottom: 5px; border-bottom: 1px solid #eee; }

        /* ★集計画面 */
        .summary-cards-container { display: flex; gap: 20px; margin-bottom: 30px; }
        .summary-card { flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .summary-card h3 { margin: 0 0 10px; color: #34495e; font-size: 1.1em; }
        .summary-card p { font-size: 2.2em; margin: 0; font-weight: bold; color: #2c3e50; }
        .summary-card p.profit { color: #27ae60; }

        /* テーブル & フォーム */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #ecf0f1; }
        .action-btn { padding: 5px 10px; margin-right: 5px; cursor: pointer; border: 1px solid #ccc; background: #fff; border-radius: 3px; }
        .form-section { background: #f9f9f9; padding: 20px; border-radius: 8px; margin-top: 20px; border: 1px solid #eee;}
        
        /* 共通 */
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 5px; padding: 16px; position: fixed; z-index: 10; right: 30px; top: 30px; font-size: 17px; opacity: 0; transition: opacity 0.5s, visibility 0.5s; }
        #toast.show { visibility: visible; opacity: 1; }
    </style>
</head>
<body>
    <div class="container">
        <nav class="left-pane">
            <div class="menu-title">メニュー</div>
            <ul id="main-menu">
                <li class="active">販売操作</li>
                <li>集計</li>
                <li>レシート履歴</li>
                <li>商品一覧設定</li>
            </ul>
        </nav>
        <main class="center-pane" id="center-pane"></main>
        <aside class="right-pane" id="right-pane"></aside>
    </div>
    <div id="toast"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let state = {
            products: [], cart: [], receipts: [], activeView: '販売操作',
            // ★変更点: レシート編集モードの状態を管理
            editMode: { active: false, receiptDate: null } 
        };

        // --- localStorage関連 ---
        function saveData() { localStorage.setItem('posData', JSON.stringify({ products: state.products, receipts: state.receipts })); }
        function loadData() {
            const data = JSON.parse(localStorage.getItem('posData'));
            if (data && data.products) { state.products = data.products; state.receipts = data.receipts || []; } 
            else { state.products = getDefaultProducts(); }
        }
        function getDefaultProducts() {
            return [
                { id: 1, name: "Tシャツ", price: 2500, cost: 1000, discountAmount: 0 },
                { id: 2, name: "トートバッグ", price: 1800, cost: 700, discountAmount: 300 },
                { id: 3, name: "ステッカー", price: 800, cost: 200, discountAmount: 0 },
            ];
        }

        const centerPane = document.getElementById('center-pane');
        const rightPane = document.getElementById('right-pane');
        const menuItems = document.querySelectorAll('#main-menu li');
        const toast = document.getElementById('toast');
        
        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }

        // --- 描画(View)関連 ---
        function render() {
            const view = state.activeView;
            rightPane.style.display = 'none';
            try {
                switch (view) {
                    case '販売操作': renderSalesView(); rightPane.style.display = 'flex'; break;
                    case '集計': renderSummaryView(); break;
                    case 'レシート履歴': renderReceiptsView(); break;
                    case '商品一覧設定': renderProductsSettingsView(); break;
                }
            } catch (error) { console.error("描画エラー:", error); centerPane.innerHTML = "<h2>エラー</h2><p>描画中に問題が発生しました。</p>"; }
        }
        
        function renderSalesView() {
            centerPane.innerHTML = '<div class="product-grid"></div>';
            // ★変更点: 編集モードに応じて表示を切り替え
            const isEditing = state.editMode.active;
            const headerClass = isEditing ? 'cart-header editing' : 'cart-header';
            const headerText = isEditing ? `レシート編集中` : '現在の会計';
            const registerBtnClass = isEditing ? 'update' : '';
            const registerBtnText = isEditing ? '更新' : '登録';
            const clearBtnText = isEditing ? '編集中止' : 'クリア';

            rightPane.innerHTML = `<div class="${headerClass}">${headerText}</div> <div class="cart-items"></div> <div class="cart-footer"> <div class="total-section"> <span class="label">合計</span> <span class="amount" id="total-amount">¥0</span> </div> <div class="action-buttons"> <button id="register-btn" class="${registerBtnClass}">${registerBtnText}</button> <button id="clear-btn">${clearBtnText}</button> </div> </div>`;
            
            renderProductsGrid();
            renderCart();
            document.getElementById('clear-btn').addEventListener('click', isEditing ? cancelEditReceipt : clearCart);
            document.getElementById('register-btn').addEventListener('click', registerSaleOrUpdateReceipt);
        }

        function renderProductsGrid() {
            const productGrid = centerPane.querySelector('.product-grid');
            if (!productGrid) return;
            productGrid.innerHTML = '';
            state.products.forEach(p => {
                const item = document.createElement('div');
                item.className = 'product-item';
                // ★変更点: 割引がある場合の価格表示を修正
                let priceHtml;
                if (p.discountAmount > 0) {
                    priceHtml = `<div class="price"><s>¥${p.price.toLocaleString()}</s> <span class="discounted">¥${(p.price - p.discountAmount).toLocaleString()}</span></div>`;
                } else {
                    priceHtml = `<div class="price">¥${p.price.toLocaleString()}</div>`;
                }
                item.innerHTML = `<div class="name">${p.name}</div>${priceHtml}`;
                item.addEventListener('click', () => addProductToCart(p.id));
                productGrid.appendChild(item);
            });
        }
        
        function renderCart() {
            // (この関数の中身は前回から変更ありません)
            const cartItemsContainer = rightPane.querySelector('.cart-items');
            if (!cartItemsContainer) return;
            cartItemsContainer.innerHTML = '';
            let total = 0;
            const normalItems = state.cart.filter(item => findProductById(item.id) && findProductById(item.id).discountAmount === 0);
            const discountedItems = state.cart.filter(item => findProductById(item.id) && findProductById(item.id).discountAmount > 0);
            const createItemHtml = (cartItem) => {
                const product = findProductById(cartItem.id);
                if(!product) return { html: '', subtotal: 0 };
                const finalPrice = product.price - product.discountAmount;
                const subtotal = finalPrice * cartItem.quantity;
                const priceHtml = product.discountAmount > 0 ? `<span class="original-price">¥${product.price.toLocaleString()}</span> ¥${finalPrice.toLocaleString()}` : `¥${product.price.toLocaleString()}`;
                const html = `<div class="cart-item"><div class="cart-item-info"><div class="name">${product.name}</div><div class="price">${cartItem.quantity} x ${priceHtml}</div></div><div class="cart-item-controls"><button class="decrease-btn" data-id="${cartItem.id}">-</button><span class="quantity">${cartItem.quantity}</span><button class="increase-btn" data-id="${cartItem.id}">+</button></div></div>`;
                return { html, subtotal };
            };
            normalItems.forEach(item => { const result = createItemHtml(item); cartItemsContainer.innerHTML += result.html; total += result.subtotal; });
            if(discountedItems.length > 0) {
                cartItemsContainer.innerHTML += '<div class="cart-separator">割引商品</div>';
                discountedItems.forEach(item => { const result = createItemHtml(item); cartItemsContainer.innerHTML += result.html; total += result.subtotal; });
            }
            rightPane.querySelector('#total-amount').textContent = `¥${Math.floor(total).toLocaleString()}`;
            addCartButtonEvents();
        }

        function renderSummaryView() {
            // ★変更点: レイアウト全体をカードデザインに刷新
            let totalRevenue = 0, totalCost = 0;
            const salesSummary = {};
            state.receipts.forEach(receipt => {
                receipt.items.forEach(item => {
                    const product = findProductById(item.id); if (!product) return;
                    if (!salesSummary[item.id]) salesSummary[item.id] = { name: product.name, quantity: 0, revenue: 0 };
                    const revenue = (product.price - product.discountAmount) * item.quantity;
                    salesSummary[item.id].quantity += item.quantity;
                    salesSummary[item.id].revenue += revenue;
                    totalRevenue += revenue;
                    totalCost += product.cost * item.quantity;
                });
            });
            const tableRows = Object.values(salesSummary).map(s => `<tr><td>${s.name}</td><td>${s.quantity}</td><td>¥${Math.floor(s.revenue).toLocaleString()}</td></tr>`).join('');
            centerPane.innerHTML = `
                <h1>集計</h1>
                <div class="summary-cards-container">
                    <div class="summary-card"><h3>総売上</h3><p>¥${Math.floor(totalRevenue).toLocaleString()}</p></div>
                    <div class="summary-card"><h3>総原価</h3><p>¥${Math.floor(totalCost).toLocaleString()}</p></div>
                    <div class="summary-card"><h3>総利益</h3><p class="profit">¥${Math.floor(totalRevenue - totalCost).toLocaleString()}</p></div>
                </div>
                <h2>商品別 売上一覧</h2>
                <table><thead><tr><th>商品名</th><th>販売数</th><th>売上</th></tr></thead><tbody>${tableRows}</tbody></table>`;
        }

        function renderReceiptsView() {
            const receiptListHtml = state.receipts.map((receipt) => {
                const itemsHtml = receipt.items.map(item => { const p = findProductById(item.id); return `<li>${p ? p.name : '削除済商品'} x ${item.quantity}</li>`; }).join('');
                return `<div class="receipt-item"><h4>レシート #${receipt.id} - ${new Date(receipt.date).toLocaleString()}</h4><p><strong>合計: ¥${receipt.total.toLocaleString()}</strong></p><ul>${itemsHtml}</ul><div style="text-align:right;"><button class="action-btn" onclick="editReceipt('${receipt.date}')">編集</button><button class="action-btn" onclick="deleteReceipt('${receipt.date}')">削除</button></div></div>`;
            }).join('');
            centerPane.innerHTML = `<h1>レシート履歴</h1><div>${receiptListHtml || '<p>まだ会計履歴はありません。</p>'}</div>`;
        }
        
        function renderProductsSettingsView() {
            const productsHtml = state.products.map(p => `<tr><td>${p.name}</td><td>¥${p.price.toLocaleString()}</td><td>¥${p.cost.toLocaleString()}</td><td>¥${p.discountAmount.toLocaleString()}</td><td><button class="action-btn" onclick="editProduct(${p.id})">編集</button><button class="action-btn" onclick="deleteProduct(${p.id})">削除</button></td></tr>`).join('');
            centerPane.innerHTML = `<h1>商品一覧設定</h1><table><thead><tr><th>名前</th><th>価格</th><th>原価</th><th>割引額</th><th>操作</th></tr></thead><tbody>${productsHtml}</tbody></table><div class="form-section"><h3 id="product-form-title">新規商品追加</h3><form id="product-form"><input type="hidden" id="product-id"><div class="form-grid"><input type="text" id="product-name" placeholder="商品名" required><input type="number" id="product-price" placeholder="価格" required><input type="number" id="product-cost" placeholder="原価" required><input type="number" id="product-discount-amount" placeholder="割引額 (なければ0)" required></div><button type="submit" style="width:100%; padding:10px; margin-top:15px; background:#2980b9; color:white; border:none; border-radius:4px;">保存</button></form></div>`;
            document.getElementById('product-form').addEventListener('submit', handleProductFormSubmit);
        }

        function handleMenuClick(event) {
            if (state.editMode.active && !confirm("レシートの編集中です。変更を破棄して移動しますか？")) return;
            cancelEditReceipt(); // 移動前に編集モードをリセット
            state.activeView = event.currentTarget.textContent;
            menuItems.forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');
            render();
        }
        function handleProductFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('product-id').value;
            const newProduct = {
                id: id ? parseInt(id) : Date.now(),
                name: document.getElementById('product-name').value, price: parseInt(document.getElementById('product-price').value) || 0,
                cost: parseInt(document.getElementById('product-cost').value) || 0, discountAmount: parseInt(document.getElementById('product-discount-amount').value) || 0 };
            if (id) { state.products = state.products.map(p => p.id === newProduct.id ? newProduct : p); } else { state.products.push(newProduct); }
            saveData(); showToast('商品を保存しました'); render();
        }
        
        window.editProduct = (id) => { const p = findProductById(id); if (!p) return; document.getElementById('product-form-title').textContent = '商品を編集'; document.getElementById('product-id').value = p.id; document.getElementById('product-name').value = p.name; document.getElementById('product-price').value = p.price; document.getElementById('product-cost').value = p.cost; document.getElementById('product-discount-amount').value = p.discountAmount; window.scrollTo(0, document.body.scrollHeight); }
        window.deleteProduct = (id) => { if (confirm('本当にこの商品を削除しますか？')) { state.products = state.products.filter(p => p.id !== id); saveData(); showToast('商品を削除しました'); render(); } }
        window.deleteReceipt = (date) => { if (confirm('本当にこのレシートを削除しますか？')) { state.receipts = state.receipts.filter(r => r.date !== date); saveData(); showToast('レシートを削除しました'); render(); } }

        // ★変更点: レシート編集のロジックをモーダルから販売画面への展開に変更
        window.editReceipt = (date) => {
            const receipt = state.receipts.find(r => r.date === date);
            if (!receipt) return;
            state.editMode = { active: true, receiptDate: date };
            state.cart = JSON.parse(JSON.stringify(receipt.items)); // 念のためディープコピー
            state.activeView = '販売操作';
            menuItems.forEach(item => item.classList.toggle('active', item.textContent === '販売操作'));
            render();
        }

        function cancelEditReceipt() {
            state.editMode = { active: false, receiptDate: null };
            state.cart = [];
            // レシート履歴画面に戻るのが親切
            state.activeView = 'レシート履歴';
            menuItems.forEach(item => item.classList.toggle('active', item.textContent === 'レシート履歴'));
            render();
        }

        function addProductToCart(productId) { const item = state.cart.find(item => item.id === productId); if (item) { item.quantity++; } else { state.cart.push({ id: productId, quantity: 1 }); } renderCart(); }
        function updateCartQuantity(productId, change) { const item = state.cart.find(item => item.id === parseInt(productId)); if (item) { item.quantity += change; if (item.quantity <= 0) state.cart = state.cart.filter(cartItem => cartItem.id !== item.id); } renderCart(); }
        function addCartButtonEvents() { rightPane.querySelectorAll('.increase-btn').forEach(btn => btn.addEventListener('click', (e) => updateCartQuantity(e.target.dataset.id, 1))); rightPane.querySelectorAll('.decrease-btn').forEach(btn => btn.addEventListener('click', (e) => updateCartQuantity(e.target.dataset.id, -1))); }
        function clearCart() { state.cart = []; renderCart(); }

        // ★変更点: 通常の登録とレシート更新を一つの関数で処理
        function registerSaleOrUpdateReceipt() {
            if (state.editMode.active) { // レシート更新の場合
                const receipt = state.receipts.find(r => r.date === state.editMode.receiptDate);
                if (!receipt) { showToast("エラー: 対象のレシートが見つかりません"); return; }
                const total = state.cart.reduce((sum, item) => { const p = findProductById(item.id); return sum + (p ? (p.price - p.discountAmount) * item.quantity : 0); }, 0);
                receipt.items = [...state.cart];
                receipt.total = Math.floor(total);
                saveData();
                showToast(`レシート #${receipt.id} を更新しました`);
                cancelEditReceipt(); // 編集モードを終了し、レシート一覧に戻る
            } else { // 通常の新規登録の場合
                if (state.cart.length === 0) { showToast('カートに商品がありません'); return; }
                const total = state.cart.reduce((sum, item) => { const p = findProductById(item.id); return sum + (p ? (p.price - p.discountAmount) * item.quantity : 0); }, 0);
                const receiptId = state.receipts.length > 0 ? Math.max(0, ...state.receipts.map(r => r.id)) + 1 : 1;
                state.receipts.unshift({ id: receiptId, date: new Date().toISOString(), items: [...state.cart], total: Math.floor(total) });
                saveData(); showToast(`¥${Math.floor(total).toLocaleString()} で売上を記録`); clearCart();
            }
        }
        
        function findProductById(id) { return state.products.find(p => p.id === id); }

        function init() { loadData(); menuItems.forEach(item => item.addEventListener('click', handleMenuClick)); render(); }
        init();
    });
    </script>
</body>
</html>